# Make Cats Free v0.4

За основу взята система из первой домашки, грубо оформленная в виде контекстов [ссылка](https://app.holst.so/share/b/ffb63878-5908-446b-9ee0-e2cf9921b865?objectId=db72d94f-b25f-47db-a63b-501c16531132)

- [Make Cats Free v0.4](#make-cats-free-v04)
  - [Изменения](#изменения)
    - [Разбираемся с внутренним устройством монолита](#разбираемся-с-внутренним-устройством-монолита)
    - [Искусство резки по монолиту](#искусство-резки-по-монолиту)
      - [Когда свободные люди и ресурсы есть, а опыта и/или инфраструктуры нет](#когда-свободные-люди-и-ресурсы-есть-а-опыта-иили-инфраструктуры-нет)
        - [Шаг 1: ~~найти ключи~~ Отделяем аукцион менеджеров](#шаг-1-найти-ключи-отделяем-аукцион-менеджеров)
        - [Шаг 2: ~~выйти из тьмы~~ Отделяем скоринг воркеров](#шаг-2-выйти-из-тьмы-отделяем-скоринг-воркеров)
        - [Шаг 3: ~~пролить огонь с небес~~ Отделяем биллинг](#шаг-3-пролить-огонь-с-небес-отделяем-биллинг)
        - [Шаг 4: ~~освободить орду~~ Меняем тип коммуникации с HCB на асинхронный](#шаг-4-освободить-орду-меняем-тип-коммуникации-с-hcb-на-асинхронный)
        - [Шаг 5: Его не будет](#шаг-5-его-не-будет)
        - [Итоговая instability](#итоговая-instability)
      - [Когда опыт и инфраструктура есть, а свободных людей/ресурсов нет](#когда-опыт-и-инфраструктура-есть-а-свободных-людейресурсов-нет)

## Изменения

Строго говоря, в исходной системе сервис один, нестабильность у него - 0.5 и если бы это была единственная характеристика, то можно было бы ничего не трогать

Но у нас другой случай, поэтому будем разбираться

### Разбираемся с внутренним устройством монолита

Сначала разберемся с боундед контекстами, потому что они сейчас мягко говоря некорректно определены

Контекст формирования заказа сейчас просто огромный, он включает в себя и матчинг воркеров и сборку расходников для заказа, эту логику нужно расцепить

Обработка заказа может казаться хорошим кандидатом на отделение, но тут нужно учитывать что возросшая нагрузка на добавление заказов прямо пропорционально увеличит нагрузку и на этот модуль/сервис, поэтому нет смысла в его обособленном существовании, он объединится с формированием заказа в управление заказами

Контекст появление новых пользователей состоит из двух не связанных друг с другом сущностей - добавления клиентов и скоринга (и найма) воркеров, их нужно разделить. В требованиях указано что в дальнейшем планируется расширить клиентскую базу за пределы штата сотрудников HCB. Поэтому этот контекст поделим на два - добавление клиентов и скоринг воркеров

Теперь, когда наш монолит приобрел чуть более вменяемое содержание, начнем его пилить

### Искусство резки по монолиту

[Итоги распила](https://app.holst.so/share/b/ffb63878-5908-446b-9ee0-e2cf9921b865?objectId=e251cbe3-c1db-4fdc-84ab-0d8dd0303f29)

#### Когда свободные люди и ресурсы есть, а опыта и/или инфраструктуры нет

##### Шаг 1: ~~найти ключи~~ Отделяем аукцион менеджеров

Это, пожалуй, самый простой для отделения сервис, потому что ~~самый бесполезный~~ имеет минимум необходимых **собственных** данных для работы и небольшую связанность с остальными частями системы, но потребуется поменять вид базы, засчет этого можно начать готовить инфраструктуру, а разработчики получат опыт

Так как придется менять тип базы, из рассмотренных в уроке стратегий нам нужно использовать change data capture

Придется добавить в инфраструктуру какой-то брокер сообщений, чтобы реализовать асинхронную коммуникацию (сервис аукционов не может ходить в базу заказов, слишком палевно)

Таким образом мы получим сервис аукционов с instability 0 и остаток монолита с instability ~0.33

##### Шаг 2: ~~выйти из тьмы~~ Отделяем скоринг воркеров

Главная причина отделения этого сервиса - требования к релизному циклу, для скоринга он должен составлять 1 неделю, для остальной системы - месяц

Несмотря на то что формально раньше это было частью другого контекста, ни вид БД ни модель данных менять не придется, поэтому для отпиливания подойдет стратегия Strangler Fig Application

Почему не tactical fork? Нам нужно переделает его под microkernel паттерн, потому что смотри [ADR 001](/Homework3/ADR-1.md)

Добавим асинхронную публикацию сообщений для остатков монолита

Получим новый сервис с instability 1 и остаток монолита с instability 0.5

##### Шаг 3: ~~пролить огонь с небес~~ Отделяем биллинг

Тут потребуется особая БД, которая соответствует CatFinCompliance, соответственно используем паттерн Change Data Capture

Собственно из-за этого комплаенса и выносим

Получим сервис с одной входящей связью - асинхронные сообщения от монолита

Таким образом у нас получается сервис с instability 0 и остаток монолита с instability 0.6

##### Шаг 4: ~~освободить орду~~ Меняем тип коммуникации с HCB на асинхронный

##### Шаг 5: Его не будет

Я может не разобрался в чем-то, но я не вижу смысла на данный момент в дальнейшем распиливании монолита "просто чтобы распилить".

##### Итоговая instability

| Сервис             | Входящие связи | Исходящие связи | instability |
| ------------------ | -------------- | --------------- | ----------- |
| Скоринг воркеров   | 0              | 1               | 1           |
| Сервис заказов(?)  | 2              | 3               | 0.6         |
| Аукцион менеджеров | 1              | 0               | 0           |
| Биллинг            | 1              | 0               | 0           |
| Fur-tune           | 1              | 0               | 0           |
| HCB                | 0              | 1               | 1           |

#### Когда опыт и инфраструктура есть, а свободных людей/ресурсов нет

Шаги те же самые что и в предыдущем варианте, но в другом порядке, сначала выносим скоринг воркеров, так как он единственный имеет отличный от остальной системы релизный цикл, плюс его планируют продавать другим компаниям
